{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<h1 class="page-title">Monitoreo de Tr√°fico en Tiempo Real</h1>
<p class="page-subtitle">Vista general del sistema de gesti√≥n de tr√°fico inteligente</p>

<!-- TARJETAS KPI -->
<div class="kpi-grid">
    <div class="kpi-card">
        <div>
            <p class="kpi-title">Veh√≠culos Detectados Hoy</p>
            <h2 class="kpi-value">{{ total_vehicles_today|default:0 }}</h2>
        </div>
        <div class="kpi-icon blue">üöó</div>
    </div>

    <div class="kpi-card">
        <div>
            <p class="kpi-title">Ciclos Ejecutados Hoy</p>
            <h2 class="kpi-value">{{ cycles_count_today|default:0 }}</h2>
        </div>
        <div class="kpi-icon green">üîÑ</div>
    </div>

    <div class="kpi-card">
        <div>
            <p class="kpi-title">Tiempo Promedio Verde</p>
            <h2 class="kpi-value">{{ avg_green_time|default:0 }} s</h2>
        </div>
        <div class="kpi-icon orange">‚è±</div>
    </div>

    <div class="kpi-card">
        <div>
            <p class="kpi-title">Total Ciclos Hist√≥rico</p>
            <h2 class="kpi-value">{{ total_cycles_all_time|default:0 }}</h2>
        </div>
        <div class="kpi-icon purple">üìä</div>
    </div>
</div>

<!-- GR√ÅFICO HORIZONTAL COMPLETO -->
<div class="chart-card" style="margin-top: 24px;">
    <h3>üìà Flujo Vehicular (√öltimas 24 Horas)</h3>
    <div style="height: 320px; position: relative;">
        <canvas id="trafficChart"></canvas>
    </div>
</div>

<!-- SECCI√ìN INFERIOR: Estado del Sistema + Actividad Reciente -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px;">

    <!-- ESTADO DEL SISTEMA EN VIVO -->
    <div class="chart-card" style="margin-top: 0;">
        <h3>üö¶ Estado del Sistema en Vivo</h3>
        <div id="live-status" style="margin-top: 16px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div style="background: #f0fdf4; padding: 16px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 6px;" id="live-total">0</div>
                    <div style="font-size: 12px; color: #16a34a; font-weight: 600;">VEH√çCULOS AHORA</div>
                </div>
                <div style="background: #eff6ff; padding: 16px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 6px;" id="live-green">-</div>
                    <div style="font-size: 12px; color: #2563eb; font-weight: 600;">EN VERDE</div>
                </div>
            </div>

            <!-- Barras por zona -->
            <div style="margin-top: 20px;">
                <div style="font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 10px;">Veh√≠culos por Zona
                </div>
                <div id="zone-bars"></div>
            </div>

            <!-- Indicador de estado -->
            <div
                style="margin-top: 16px; display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                <div id="status-dot"
                    style="width: 12px; height: 12px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite;">
                </div>
                <span id="status-text" style="font-size: 13px; color: #475569; font-weight: 500;">Sistema activo</span>
            </div>
        </div>
    </div>

    <!-- RESUMEN R√ÅPIDO -->
    <div class="chart-card" style="margin-top: 0;">
        <h3>üìã Resumen del D√≠a</h3>
        <div style="margin-top: 16px;">

            <!-- Mini stats -->
            <div style="display: flex; flex-direction: column; gap: 14px;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #fef3c7; border-radius: 10px;">
                    <div>
                        <div style="font-size: 13px; color: #92400e; font-weight: 600;">üïê Hora Pico</div>
                        <div style="font-size: 11px; color: #a16207; margin-top: 2px;">Mayor tr√°fico detectado</div>
                    </div>
                    <div id="peak-hour" style="font-size: 22px; font-weight: 700; color: #92400e;">--:00</div>
                </div>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #dbeafe; border-radius: 10px;">
                    <div>
                        <div style="font-size: 13px; color: #1e40af; font-weight: 600;">üìä Promedio por Ciclo</div>
                        <div style="font-size: 11px; color: #3b82f6; margin-top: 2px;">Veh√≠culos por ciclo</div>
                    </div>
                    <div style="font-size: 22px; font-weight: 700; color: #1e40af;">{{ total_vehicles_today|default:0 }}
                    </div>
                </div>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #dcfce7; border-radius: 10px;">
                    <div>
                        <div style="font-size: 13px; color: #166534; font-weight: 600;">‚úÖ Eficiencia</div>
                        <div style="font-size: 11px; color: #16a34a; margin-top: 2px;">Estado general del sistema</div>
                    </div>
                    <div style="font-size: 22px; font-weight: 700; color: #166534;" id="efficiency-val">ESPERA</div>
                </div>

                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #fce7f3; border-radius: 10px;">
                    <div>
                        <div style="font-size: 13px; color: #9d174d; font-weight: 600;">üîÅ √öltimo Ciclo</div>
                        <div style="font-size: 11px; color: #be185d; margin-top: 2px;">Tiempo del √∫ltimo ciclo verde
                        </div>
                    </div>
                    <div style="font-size: 22px; font-weight: 700; color: #9d174d;">{{ avg_green_time|default:0 }}s
                    </div>
                </div>
            </div>

            <!-- Accesos r√°pidos -->
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <a href="/intersections/"
                    style="flex: 1; padding: 12px; background: #1e40af; color: white; text-align: center; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s;"
                    onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#1e40af'">
                    üö¶ Ir a Control
                </a>
                <a href="/reports/"
                    style="flex: 1; padding: 12px; background: #7c3aed; color: white; text-align: center; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: 600; transition: all 0.2s;"
                    onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                    üìà Ver Reportes
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.4;
        }
    }

    .zone-bar-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }

    .zone-bar-label {
        min-width: 50px;
        font-size: 12px;
        font-weight: 600;
        color: #475569;
    }

    .zone-bar-bg {
        flex: 1;
        height: 22px;
        background: #f1f5f9;
        border-radius: 6px;
        overflow: hidden;
    }

    .zone-bar-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        padding-left: 8px;
        font-size: 11px;
        font-weight: 700;
        color: white;
        min-width: 0;
    }
</style>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ hourly_data|json_script:"hourly-data" }}

<script>
    // === GR√ÅFICO DE 24 HORAS ===
    const hourlyData = JSON.parse(document.getElementById('hourly-data').textContent);

    const now = new Date();
    const labels = [];
    for (let i = 23; i >= 0; i--) {
        const hour = new Date(now - i * 60 * 60 * 1000);
        labels.push(hour.getHours() + ':00');
    }

    // Encontrar hora pico
    let maxVal = 0, maxIdx = 0;
    hourlyData.forEach((v, i) => { if (v > maxVal) { maxVal = v; maxIdx = i; } });
    const peakEl = document.getElementById('peak-hour');
    if (peakEl && maxVal > 0) {
        peakEl.textContent = labels[maxIdx];
    }

    const ctx = document.getElementById('trafficChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 320);
    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
    gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Veh√≠culos Detectados',
                data: hourlyData,
                borderColor: '#3b82f6',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointBackgroundColor: '#3b82f6',
                pointRadius: 3,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 },
                    grid: { color: 'rgba(0,0,0,0.04)' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // === ESTADO EN VIVO ===
    const zoneColors = ['#ef4444', '#3b82f6', '#3b82f6', '#ef4444', '#10b981', '#10b981'];
    const zoneNames = ['A', 'B', 'C', 'D', 'E', 'F'];

    function buildZoneBars() {
        const container = document.getElementById('zone-bars');
        if (!container) return;
        container.innerHTML = '';
        zoneNames.forEach((name, i) => {
            container.innerHTML += `
                <div class="zone-bar-row">
                    <span class="zone-bar-label">Zona ${name}</span>
                    <div class="zone-bar-bg">
                        <div class="zone-bar-fill" id="zone-fill-${i}" style="width: 0%; background: ${zoneColors[i]};"></div>
                    </div>
                    <span style="min-width:24px; text-align:right; font-size:13px; font-weight:700; color:#1e293b;" id="zone-count-${i}">0</span>
                </div>`;
        });
    }
    buildZoneBars();

    async function updateLiveStatus() {
        try {
            const res = await fetch('/traffic_status/');
            const data = await res.json();

            const counts = data.counts || [0, 0, 0, 0, 0, 0];
            const total = counts.reduce((a, b) => a + b, 0);
            const maxCount = Math.max(...counts, 1);

            document.getElementById('live-total').textContent = total;

            // Green lanes
            const states = data.lights || ['R', 'R', 'R', 'R', 'R', 'R'];
            const greens = [];
            states.forEach((s, i) => { if (s === 'G') greens.push(zoneNames[i]); });
            document.getElementById('live-green').textContent = greens.length > 0 ? greens.join(', ') : '-';

            // Zone bars
            counts.forEach((c, i) => {
                const fill = document.getElementById(`zone-fill-${i}`);
                const countEl = document.getElementById(`zone-count-${i}`);
                if (fill) {
                    const pct = Math.max((c / maxCount) * 100, c > 0 ? 15 : 0);
                    fill.style.width = pct + '%';
                    fill.textContent = c > 0 ? c : '';
                }
                if (countEl) countEl.textContent = c;
            });

            // Status
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if (data.controller_running) {
                dot.style.background = '#10b981';
                txt.textContent = total > 0 ? `Sistema activo ‚Äî ${total} veh√≠culos detectados` : 'Sistema activo ‚Äî sin tr√°fico';
            } else {
                dot.style.background = '#f59e0b';
                txt.textContent = 'Sistema en espera';
            }
        } catch (e) {
            console.error('Error actualizando estado:', e);
        }
    }

    setInterval(updateLiveStatus, 1500);
    updateLiveStatus();
</script>
{% endblock %}